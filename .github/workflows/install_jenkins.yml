on:
  workflow_dispatch:
    
jobs:
  install-jenkins:
    runs-on: ubuntu-22.04
    name: install jenkins and nginx
    permissions:
      id-token: write
    steps:
    - name: Configure Aws Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: eu-north-1
        role-to-assume: arn:aws:iam::222896848746:role/GithubActionsRole
    - name: Checkout
      uses: actions/checkout@v4
    - name: install ansible
      run: |
        sudo apt-add-repository ppa:ansible/ansible
        sudo apt update
        sudo apt install ansible
    - name: install aws inventory
      run: |
        ansible-galaxy collection install amazon.aws
    - name: get info from ec2 instances
      run: |
        ansible-inventory -i my_inv.aws_ec2.yaml --list
        K3SMASTER_IP = $(jq -r '.["_meta"].hostvars[] | select(.tags.Name == "K3s_Master_instance") | .private_ip_address' inventory.json)
        echo "k3s master IP is: $K3SMASTER_IP"
        BASTION_HOST_IP = $(jq -r '.["_meta"].hostvars[] | select(.tags.Name == "K3s_Master_instance") | .public_ip_address' inventory.json)
        echo "k3s master IP is: $BASTION_HOST_IP"
 